name: OHLCV Feed (Binance Spot) - Core10 TXT (H1/H4/D1/W1, closed, resilient)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly UTC

permissions:
  contents: write

concurrency:
  group: ohlcv-feed
  cancel-in-progress: true

jobs:
  build-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build TXT feed (CSV in .txt), closed only + symbols.json + index
        shell: bash
        run: |
          set -euo pipefail
          python - << 'PY'
          import json, os, time, glob
          from datetime import datetime, timezone
          from urllib.parse import urlencode
          from urllib.request import Request, urlopen
          from urllib.error import HTTPError, URLError

          BASES = [
            "https://data-api.binance.vision",
            "https://api.binance.com",
          ]

          OUT_DIR = "ohlcv/binance"
          CORE10 = ["BTCUSDT","ETHUSDT","SOLUSDT","BNBUSDT","AVAXUSDT","LINKUSDT","AAVEUSDT","UNIUSDT","ARBUSDT","ADAUSDT"]

          # tf -> (binance interval, limit)
          # limit max = 1000; H1 ставим 720 (~30 дней) чтобы реже ловить 429
          TFS = {
            "H1": ("1h", 720),
            "H4": ("4h", 240),
            "D1": ("1d", 365),
            "W1": ("1w", 260),
          }

          # пауза между запросами против 429
          SLEEP_PER_CALL = 0.12

          def iso_utc(ms: int) -> str:
            return datetime.fromtimestamp(ms/1000, tz=timezone.utc).isoformat().replace("+00:00","Z")

          def http_get_json(path, params=None, timeout=35, retries=10):
            last_err = None
            for base in BASES:
              url = base + path
              if params:
                url += "?" + urlencode(params)

              backoff = 1.0
              for i in range(retries):
                try:
                  req = Request(url, headers={"User-Agent":"ohlcv-feed/6.0"})
                  with urlopen(req, timeout=timeout) as r:
                    return json.loads(r.read().decode("utf-8"))

                except HTTPError as e:
                  last_err = e
                  code = getattr(e, "code", None)

                  # Binance: 429/418 rate-limit, 5xx — временно
                  if code in (418, 429, 500, 502, 503, 504):
                    print(f"[WARN] HTTP {code} {url} (try {i+1}/{retries}) sleep={backoff:.1f}s")
                    time.sleep(backoff)
                    backoff = min(backoff * 1.6, 15.0)
                    continue

                  body = ""
                  try:
                    body = e.read().decode("utf-8")[:300]
                  except Exception:
                    pass
                  raise RuntimeError(f"HTTP {code} {url} :: {body}")

                except URLError as e:
                  last_err = e
                  print(f"[WARN] URLError {url} (try {i+1}/{retries}) sleep={backoff:.1f}s :: {e}")
                  time.sleep(backoff)
                  backoff = min(backoff * 1.6, 15.0)
                  continue

                finally:
                  time.sleep(SLEEP_PER_CALL)

            raise RuntimeError(f"Failed GET {path} params={params} last_err={last_err}")

          print("[INFO] Fetch server time…")
          now_ms = int(http_get_json("/api/v3/time")["serverTime"])
          print(f"[INFO] serverTime={now_ms} ({iso_utc(now_ms)})")

          os.makedirs(OUT_DIR, exist_ok=True)

          # чистим старые файлы (чтобы не было мусора)
          for p in glob.glob(os.path.join(OUT_DIR, "*")):
            if os.path.isfile(p):
              os.remove(p)

          header = "open_ms,open,high,low,close,volume,close_ms\n"

          last_close_ms_all = []
          last_close_by_tf = {tf: None for tf in TFS.keys()}

          total_calls = len(CORE10) * len(TFS)
          call_n = 0

          for sym in CORE10:
            for tf, (interval, limit) in TFS.items():
              call_n += 1
              print(f"[INFO] ({call_n}/{total_calls}) {sym} {tf} interval={interval} limit={limit}")
              kl = http_get_json("/api/v3/klines", {"symbol": sym, "interval": interval, "limit": str(limit)})

              closed = [k for k in kl if int(k[6]) <= now_ms]
              if not closed:
                raise RuntimeError(f"No closed candles for {sym} {tf}")

              last_close_ms = int(closed[-1][6])
              last_close_ms_all.append(last_close_ms)

              if last_close_by_tf[tf] is None or last_close_ms > last_close_by_tf[tf]:
                last_close_by_tf[tf] = last_close_ms

              path = os.path.join(OUT_DIR, f"{sym}_{tf}.txt")
              with open(path, "w", encoding="utf-8") as f:
                f.write(header)
                for k in closed:
                  f.write(
                    f"{int(k[0])},{float(k[1])},{float(k[2])},{float(k[3])},"
                    f"{float(k[4])},{float(k[5])},{int(k[6])}\n"
                  )

          updated_utc = iso_utc(max(last_close_ms_all)) if last_close_ms_all else iso_utc(now_ms)

          manifest = {
            "schema": "ohlcv-symbols-v3",
            "source": "Binance/spot",
            "timezone": "UTC",
            "symbols": CORE10,
            "updated_utc": updated_utc,
            "tfs": list(TFS.keys()),
            "paths": {"txt_per_tf": "/ohlcv/binance/{SYMBOL}_{TF}.txt"},
            "format": "CSV",
            "columns": ["open_ms","open","high","low","close","volume","close_ms"],
            "closed_only": True,
            "last_close_utc_by_tf": {tf: (iso_utc(ms) if ms else None) for tf, ms in last_close_by_tf.items()}
          }

          with open(os.path.join(OUT_DIR, "symbols.json"), "w", encoding="utf-8") as f:
            json.dump(manifest, f, ensure_ascii=False, indent=2)

          def links(sym: str) -> str:
            return (
              f"<a href='ohlcv/binance/{sym}_H1.txt'>{sym}_H1</a> | "
              f"<a href='ohlcv/binance/{sym}_H4.txt'>{sym}_H4</a> | "
              f"<a href='ohlcv/binance/{sym}_D1.txt'>{sym}_D1</a> | "
              f"<a href='ohlcv/binance/{sym}_W1.txt'>{sym}_W1</a>"
            )

          items = "\n".join([f"<li>{links(s)}</li>" for s in CORE10])

          html = f"""<!doctype html>
          <meta charset="utf-8">
          <title>OHLCV Feed</title>
          <h3>OHLCV Feed (Binance Spot) — TXT only (CSV)</h3>
          <p>Updated (UTC, latest closed): <code>{updated_utc}</code></p>
          <p>Manifest: <a href="ohlcv/binance/symbols.json">symbols.json</a></p>
          <ul>
          {items}
          </ul>
          """
          with open("index.html", "w", encoding="utf-8") as f:
            f.write(html)

          with open(".nojekyll", "w", encoding="utf-8") as f:
            f.write("")
          print("[OK] Build complete.")
          PY

      - name: Commit & push (only if changed)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -A

          # Нет изменений — выходим без ошибок (без if/fi).
          git diff --cached --quiet && { echo "No changes to commit."; exit 0; }

          git commit -m "Update OHLCV feed (TXT CSV, H1/H4/D1/W1)"
          git push

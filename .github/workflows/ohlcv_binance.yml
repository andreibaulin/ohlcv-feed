name: OHLCV Feed (Binance Spot) - Core10 H4/D1/W1

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # каждый час (UTC)

permissions:
  contents: write  # чтобы workflow мог коммитить и пушить обновления 2

concurrency:
  group: ohlcv-feed
  cancel-in-progress: true

jobs:
  build-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch OHLCV from Binance and write JSON
        shell: bash
        run: |
          python - << 'PY'
          import json, os
          from datetime import datetime, timezone
          from urllib.parse import urlencode
          from urllib.request import Request, urlopen

          BASE = "https://data-api.binance.vision"  # Binance Spot REST
          CORE10 = ["BTCUSDT","ETHUSDT","SOLUSDT","BNBUSDT","AVAXUSDT","LINKUSDT","AAVEUSDT","UNIUSDT","ARBUSDT","ADAUSDT"]

          TF_MAP = {"H4":"4h", "D1":"1d", "W1":"1w"}  # интервалы чувствительны к регистру 3
          LIMIT = 500  # /api/v3/klines default 500, max 1000 4

          def http_get(path: str, params: dict | None = None):
            qs = ("?" + urlencode(params)) if params else ""
            url = BASE + path + qs
            req = Request(url, headers={"User-Agent": "ohlcv-feed-gh-actions"})
            with urlopen(req, timeout=30) as r:
              return json.loads(r.read().decode("utf-8"))

          def iso_utc(ms: int) -> str:
            return datetime.fromtimestamp(ms / 1000, tz=timezone.utc).isoformat().replace("+00:00", "Z")

          out_dir = os.path.join("ohlcv", "binance")
          os.makedirs(out_dir, exist_ok=True)

          generated_utc = datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

          for sym in CORE10:
            payload = {
              "meta": {
                "source": "Binance/Spot",
                "symbol": sym,
                "quote": "USDT",
                "timezone": "UTC",
                "generated_utc": generated_utc
              }
            }

            for tf_key, interval in TF_MAP.items():
              kl = http_get("/api/v3/klines", {"symbol": sym, "interval": interval, "limit": str(LIMIT)})
              # Binance kline fields:
              # [openTime, open, high, low, close, volume, closeTime, quoteVol, trades, takerBuyBaseVol, takerBuyQuoteVol, ignore] 5

              data = []
              for row in kl:
                t_open = int(row[0])
                o = float(row[1]); h = float(row[2]); l = float(row[3]); c = float(row[4]); v = float(row[5])
                data.append([t_open, o, h, l, c, v])

              last_close_ms = int(kl[-1][6])
              payload[tf_key] = {
                "tf": tf_key,
                "bars": len(data),
                "last_close_utc": iso_utc(last_close_ms),
                "data": data
              }

            with open(os.path.join(out_dir, f"{sym}.json"), "w", encoding="utf-8") as f:
              json.dump(payload, f, ensure_ascii=False, separators=(",", ":"))

          with open(os.path.join(out_dir, "symbols.json"), "w", encoding="utf-8") as f:
            json.dump({"symbols": CORE10, "generated_utc": generated_utc}, f, ensure_ascii=False, indent=2)

          with open("index.html", "w", encoding="utf-8") as f:
            f.write("<!doctype html><meta charset='utf-8'><title>OHLCV Feed</title>"
                    "<pre>OHLCV Feed (Binance Spot) generated by GitHub Actions.\n"
                    "Path: /ohlcv/binance/SYMBOL.json (contains H4, D1, W1)\n\n"
                    "Symbols:\n" + "\n".join(CORE10) + "\n</pre>")
          PY

      - name: Commit & push (only if changed)
        shell: bash
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Update OHLCV feed (Binance) [skip ci]" || exit 0
            git push
          else
            echo "No changes."
          fi
        

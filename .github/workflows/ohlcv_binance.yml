name: OHLCV Feed (Binance Spot) - Core10 H4/D1/W1 (pretty + min, closed, stable commits)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # каждый час (UTC)

permissions:
  contents: write

concurrency:
  group: ohlcv-feed
  cancel-in-progress: true

jobs:
  build-feed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch OHLCV from Binance and write JSON (pretty + min, closed only)
        shell: bash
        run: |
          python - << 'PY'
          import json, os, time
          from datetime import datetime, timezone
          from urllib.parse import urlencode
          from urllib.request import Request, urlopen
          from urllib.error import HTTPError, URLError

          # Market Data Only base endpoint (обычно не ловит 451 в GitHub Actions)
          BASE = "https://data-api.binance.vision"

          CORE10 = [
            "BTCUSDT","ETHUSDT","SOLUSDT","BNBUSDT","AVAXUSDT",
            "LINKUSDT","AAVEUSDT","UNIUSDT","ARBUSDT","ADAUSDT"
          ]

          TF_ORDER = [("H4", "4h"), ("D1", "1d"), ("W1", "1w")]
          LIMIT = 240  # удобно читать, достаточно для свинга

          def iso_utc(ms: int) -> str:
            return datetime.fromtimestamp(ms / 1000, tz=timezone.utc).isoformat().replace("+00:00", "Z")

          def http_get(path, params=None, retries=4):
            qs = ("?" + urlencode(params)) if params else ""
            url = BASE + path + qs
            last_err = None
            for i in range(retries):
              try:
                req = Request(url, headers={"User-Agent": "ohlcv-feed-gh-actions"})
                with urlopen(req, timeout=30) as r:
                  return json.loads(r.read().decode("utf-8"))
              except (HTTPError, URLError) as e:
                last_err = e
                time.sleep(1.2 * (i + 1))
            raise last_err

          # Binance server time (ms) — режем незакрытую свечу
          now_ms = int(http_get("/api/v3/time")["serverTime"])

          out_dir = os.path.join("ohlcv", "binance")
          os.makedirs(out_dir, exist_ok=True)

          h4_last_close_all = []

          for sym in CORE10:
            payload = {
              "meta": {
                "source": "Binance/Spot",
                "symbol": sym,
                "quote": "USDT",
                "timezone": "UTC"
              }
            }

            last_close_h4_ms = None

            for tf_key, interval in TF_ORDER:
              kl = http_get("/api/v3/klines", {"symbol": sym, "interval": interval, "limit": str(LIMIT)})
              if not isinstance(kl, list) or len(kl) == 0:
                raise RuntimeError(f"Empty klines for {sym} {tf_key}")

              # ТОЛЬКО закрытые свечи: closeTime <= serverTime
              closed = [row for row in kl if int(row[6]) <= now_ms]
              if len(closed) < 10:
                raise RuntimeError(f"Not enough closed candles for {sym} {tf_key}")

              data = []
              for row in closed:
                t_open = int(row[0])
                o = float(row[1]); h = float(row[2]); l = float(row[3]); c = float(row[4]); v = float(row[5])
                data.append([t_open, o, h, l, c, v])

              last_close_ms = int(closed[-1][6])

              payload[tf_key] = {
                "tf": tf_key,
                "bars": len(data),
                "last_close_utc": iso_utc(last_close_ms),
                "data": data
              }

              if tf_key == "H4":
                last_close_h4_ms = last_close_ms

            # generated_utc привязываем к последнему закрытию H4 (чтобы не было “пустых” коммитов)
            if last_close_h4_ms is not None:
              payload["meta"]["generated_utc"] = iso_utc(last_close_h4_ms)
              payload["meta"]["last_h4_close_utc"] = iso_utc(last_close_h4_ms)
              h4_last_close_all.append(last_close_h4_ms)
            else:
              payload["meta"]["generated_utc"] = iso_utc(now_ms)

            # pretty JSON (читабельно)
            with open(os.path.join(out_dir, f"{sym}.json"), "w", encoding="utf-8") as f:
              json.dump(payload, f, ensure_ascii=False, indent=2)

            # minified JSON (для “машин”)
            with open(os.path.join(out_dir, f"{sym}.min.json"), "w", encoding="utf-8") as f:
              json.dump(payload, f, ensure_ascii=False, separators=(",", ":"))

          updated_utc = iso_utc(max(h4_last_close_all)) if h4_last_close_all else iso_utc(now_ms)

          # symbols.json — стабильный (без serverTime), чтобы не было коммита каждый час
          symbols_payload = {
            "symbols": CORE10,
            "updated_utc": updated_utc,
            "generated_utc": updated_utc,
            "source": "Binance/Spot",
            "timezone": "UTC",
            "tfs": ["H4", "D1", "W1"],
            "limit": LIMIT,
            "closed_only": True,
            "files": {
              "pretty": "ohlcv/binance/SYMBOL.json",
              "min": "ohlcv/binance/SYMBOL.min.json"
            }
          }

          with open(os.path.join(out_dir, "symbols.json"), "w", encoding="utf-8") as f:
            json.dump(symbols_payload, f, ensure_ascii=False, indent=2)

          # index.html со ссылками
          pretty_links = "\n".join([f"<li><a href='ohlcv/binance/{s}.json'>{s}.json</a></li>" for s in CORE10])
          min_links = "\n".join([f"<li><a href='ohlcv/binance/{s}.min.json'>{s}.min.json</a></li>" for s in CORE10])

          html = f"""<!doctype html>
          <meta charset="utf-8">
          <title>OHLCV Feed</title>
          <h3>OHLCV Feed (Binance Spot)</h3>
          <p>Last update (UTC, by last closed H4): <code>{updated_utc}</code></p>
          <p>Closed candles only. Timeframes inside each file: H4, D1, W1.</p>
          <p>Symbols list: <a href="ohlcv/binance/symbols.json">symbols.json</a></p>

          <h4>Pretty JSON (recommended for reading)</h4>
          <ul>{pretty_links}</ul>

          <h4>Minified JSON (machine-friendly)</h4>
          <ul>{min_links}</ul>
          """
          with open("index.html", "w", encoding="utf-8") as f:
            f.write(html)

          # отключаем Jekyll
          with open(".nojekyll", "w", encoding="utf-8") as f:
            f.write("")

          print("Done.")
          PY

      - name: Commit & push (only if changed)
        shell: bash
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Update OHLCV feed (pretty+min, closed only) [skip ci]" || exit 0
            git push
          else
            echo "No changes."
          fi

name: Update OHLCV feed

on:
  workflow_dispatch:
  schedule:
    - cron: "7 * * * *" # hourly at :07 UTC

permissions:
  contents: write

concurrency:
  group: ohlcv-feed
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate feed
        run: python scripts/generate_feed.py

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs scripts
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "update feed: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push.join(OHLCV_DIR, "core5_latest.json"),  {"meta": meta5,  "data": data5})

            # deriv packs (best-effort)
            d10 = {}
            warnings = []
            for sym in CORE10:
              try:
                d10[sym] = fetch_deriv(sym)
              except Exception as e:
                d10[sym] = {"source":"none"}
                warnings.append(f"{sym}: {e}")
              time.sleep(0.05)
            d5 = {k: d10[k] for k in CORE5}
            dmeta = {"timezone":"UTC","generated_utc":gen,"warnings":warnings[:100]}

            write_json(os.path.join(DERIV_DIR, "core10_latest.json"), {"meta": dmeta, "data": d10})
            write_json(os.path.join(DERIV_DIR, "core5_latest.json"),  {"meta": dmeta, "data": d5})

            # one entrypoint
            write_json(os.path.join(OUT_ROOT, "feed.json"), {
              "updated_utc": gen,
              "entrypoints": {
                "manifest": "ohlcv/binance/symbols.json",
                "core5_ohlcv": "ohlcv/binance/core5_latest.json",
                "core10_ohlcv": "ohlcv/binance/core10_latest.json",
                "core5_deriv": "deriv/binance/core5_latest.json",
                "core10_deriv": "deriv/binance/core10_latest.json"
              }
            })

            # clickable index + nojekyll
            write_text(os.path.join(OUT_ROOT, ".nojekyll"), "")
            write_text(os.path.join(OUT_ROOT, "index.html"),
              f'<!doctype html><meta charset="utf-8"><title>ohlcv-feed</title>'
              f'<h1>ohlcv-feed</h1><p>updated_utc: <code>{gen}</code></p>'
              f'<ul>'
              f'<li><a href="feed.json">feed.json</a></li>'
              f'<li><a href="ohlcv/binance/symbols.json">symbols.json</a></li>'
              f'<li><a href="ohlcv/binance/core5_latest.json">core5_latest.json</a></li>'
              f'<li><a href="deriv/binance/core5_latest.json">deriv core5_latest.json</a></li>'
              f'</ul>'
            )

            print("OK generated_utc =", gen)

          if __name__ == "__main__":
            build()
          PY

      - name: Commit & push if changed
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "update feed: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git pushnow_ms <= ct:  # not closed
                  continue
                o,h,l,c,v = row[1], row[2], row[3], row[4], row[5]
                out.append([ot, o, h, l, c, v, ct])
              if not out:
                raise RuntimeError("no closed binance klines after filter")
              return "binance", out
            except Exception as e1:
              # fallback Bybit
              kl2 = fetch_klines_bybit(symbol, tfk, limit)
              return "bybit", kl2

          def fetch_deriv(symbol: str):
            try:
              return fetch_deriv_binance(symbol)
            except Exception:
              return fetch_deriv_bybit(symbol)

          def build_ohlcv_outputs(symbols):
            out = {}
            source_map = {}
            for sym in symbols:
              out[sym] = {}
              source_map[sym] = {}
              for tfk in TFS.keys():
                src, rows = fetch_klines(sym, tfk)
                source_map[sym][tfk] = src

                last = rows[-1]
                last_close_ms = int(last[6])

                # txt post-line: openTime,open,high,low,close,volume,closeTime
                lines = []
                pack_rows = []
                for r in rows:
                  ot, o, h, l, c, v, ct = int(r[0]), r[1], r[2], r[3], r[4], r[5], int(r[6])
                  lines.append(f"{ot},{o},{h},{l},{c},{v},{ct}")
                  pack_rows.append([ot, float(o), float(h), float(l), float(c), float(v)])

                txt_path = os.path.join(OHLCV_DIR, f"{sym}_{tfk}.txt")
                write_text(txt_path, "\n".join(lines) + "\n")

                out[sym][tfk] = {
                  "tf": tfk,
                  "bars": len(pack_rows),
                  "last_close_utc": iso_utc(last_close_ms),
                  "data": pack_rows
                }

                time.sleep(0.08)  # лёгкий анти-лимит
            return out, source_map

          def build_deriv_outputs(symbols):
            out = {}
            warnings = []
            for sym in symbols:
              try:
                out[sym] = fetch_deriv(sym)
              except Exception as e:
                out[sym] = {"source":"none"}
                warnings.append(f"{sym}: {e}")
              time.sleep(0.05)
            return out, warnings

          def build_index_html(gen_utc: str):
            links = [
              ("feed.json", "feed.json (one entrypoint)"),
              ("ohlcv/binance/symbols.json", "ohlcv manifest: symbols.json"),
              ("ohlcv/binance/core5_latest.json", "OHLCV pack: core5_latest.json"),
              ("ohlcv/binance/core10_latest.json", "OHLCV pack: core10_latest.json"),
              ("deriv/binance/core5_latest.json", "DERIV pack: core5_latest.json"),
              ("deriv/binance/core10_latest.json", "DERIV pack: core10_latest.json"),
            ]
            rows = []
            for sym in CORE10:
              parts = [f'<a href="ohlcv/binance/{sym}_{tfk}.txt">{tfk}</a>' for tfk in TFS.keys()]
              rows.append(f"<tr><td>{sym}</td><td>{' | '.join(parts)}</td></tr>")
            html = f"""<!doctype html>
<html><head><meta charset="utf-8"><title>OHLCV Feed</title></head>
<body>
<h1>OHLCV/DERIV Feed</h1>
<p>updated_utc: <code>{gen_utc}</code></p>
<ul>
{''.join([f'<li><a href="{href}">{label}</a></li>' for href,label in links])}
</ul>
<h2>Per-symbol OHLCV files</h2>
<table border="1" cellpadding="6" cellspacing="0">
<tr><th>Symbol</th><th>TF files</th></tr>
{''.join(rows)}
</table>
</body></html>"""
            write_text(os.path.join(OUT_ROOT, "index.html"), html)

          def main():
            gen = now_iso()

            ensure_dir(OHLCV_DIR)
            ensure_dir(DERIV_DIR)
            ensure_dir(OUT_ROOT)

            # manifest
            symbols_manifest = {
              "tfs": list(TFS.keys()),
              "updated_utc": gen,
              "symbols": CORE10
            }
            write_json(os.path.join(OHLCV_DIR, "symbols.json"), symbols_manifest)

            # OHLCV (hard requirement)
            core10_ohlcv, core10_srcmap = build_ohlcv_outputs(CORE10)
            core5_ohlcv  = {k: core10_ohlcv[k] for k in CORE5}
            core5_srcmap = {k: core10_srcmap[k] for k in CORE5}

            meta = {
              "source_primary": "binance-usdm-public",
              "source_fallback": "bybit-linear-public",
              "timezone": "UTC",
              "generated_utc": gen,
              "tfs": list(TFS.keys()),
              "ohlcv_source_map": core10_srcmap
            }
            write_json(os.path.join(OHLCV_DIR, "core5_latest.json"),  {"meta": meta | {"ohlcv_source_map": core5_srcmap}, "data": core5_ohlcv})
            write_json(os.path.join(OHLCV_DIR, "core10_latest.json"), {"meta": meta, "data": core10_ohlcv})

            # Derivatives (best-effort)
            core10_deriv, warnings = build_deriv_outputs(CORE10)
            core5_deriv = {k: core10_deriv[k] for k in CORE5}
            dmeta = {
              "timezone": "UTC",
              "generated_utc": gen,
              "warnings": warnings[:100]
            }
            write_json(os.path.join(DERIV_DIR, "core5_latest.json"),  {"meta": dmeta, "data": core5_deriv})
            write_json(os.path.join(DERIV_DIR, "core10_latest.json"), {"meta": dmeta, "data": core10_deriv})

            # one entrypoint
            feed = {
              "updated_utc": gen,
              "entrypoints": {
                "manifest": "ohlcv/binance/symbols.json",
                "core5_ohlcv": "ohlcv/binance/core5_latest.json",
                "core10_ohlcv": "ohlcv/binance/core10_latest.json",
                "core5_deriv": "deriv/binance/core5_latest.json",
                "core10_deriv": "deriv/binance/core10_latest.json"
              }
            }
            write_json(os.path.join(OUT_ROOT, "feed.json"), feed)

            # clickable index
            build_index_html(gen)

            # .nojekyll
            write_text(os.path.join(OUT_ROOT, ".nojekyll"), "")

            print("OK. generated_utc =", gen)

          if __name__ == "__main__":
            main()
          PY

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "update feed: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push

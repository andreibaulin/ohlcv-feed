name: Deploy OHLCV TXT feed to GitHub Pages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly UTC

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build site (TXT only)
        shell: bash
        run: |
          python - << 'PY'
          import json, os, time, csv
          from datetime import datetime, timezone
          from urllib.parse import urlencode
          from urllib.request import Request, urlopen
          from urllib.error import HTTPError, URLError

          BASES = ["https://data-api.binance.vision","https://api.binance.com"]
          CORE10 = ["BTCUSDT","ETHUSDT","SOLUSDT","BNBUSDT","AVAXUSDT","LINKUSDT","AAVEUSDT","UNIUSDT","ARBUSDT","ADAUSDT"]
          TFS = {"H4":("4h",240),"D1":("1d",365),"W1":("1w",260)}

          SITE_DIR = "site"
          OUT_DIR = os.path.join(SITE_DIR, "ohlcv/binance")
          os.makedirs(OUT_DIR, exist_ok=True)

          def iso_utc(ms:int)->str:
            return datetime.fromtimestamp(ms/1000, tz=timezone.utc).isoformat().replace("+00:00","Z")

          def http_get_json(path, params=None, timeout=30, retries=4):
            last_err=None
            for base in BASES:
              url = base + path + (("?" + urlencode(params)) if params else "")
              for i in range(retries):
                try:
                  req = Request(url, headers={"User-Agent":"ohlcv-feed-pages/1.0"})
                  with urlopen(req, timeout=timeout) as r:
                    return json.loads(r.read().decode("utf-8"))
                except (HTTPError, URLError) as e:
                  last_err=e
                  time.sleep(1.2*(i+1))
            raise last_err

          now_ms = int(http_get_json("/api/v3/time")["serverTime"])

          last_h4_close_ms_all = []

          for sym in CORE10:
            for tf, (interval, limit) in TFS.items():
              kl = http_get_json("/api/v3/klines", {"symbol": sym, "interval": interval, "limit": str(limit)})
              closed = [k for k in kl if int(k[6]) <= now_ms]
              if not closed:
                raise RuntimeError(f"No closed candles for {sym} {tf}")

              if tf == "H4":
                last_h4_close_ms_all.append(int(closed[-1][6]))

              txt_path = os.path.join(OUT_DIR, f"{sym}_{tf}.txt")
              with open(txt_path, "w", encoding="utf-8", newline="") as f:
                w = csv.writer(f, lineterminator="\n")
                w.writerow(["open_ms","open","high","low","close","volume","close_ms"])
                for k in closed:
                  w.writerow([int(k[0]), float(k[1]), float(k[2]), float(k[3]), float(k[4]), float(k[5]), int(k[6])])

          updated_utc = iso_utc(max(last_h4_close_ms_all)) if last_h4_close_ms_all else iso_utc(now_ms)

          manifest = {
            "schema":"ohlcv-symbols-v2",
            "source":"Binance/spot",
            "timezone":"UTC",
            "symbols": CORE10,
            "updated_utc": updated_utc,
            "tfs": list(TFS.keys()),
            "paths": {"txt_per_tf": "/ohlcv/binance/{SYMBOL}_{TF}.txt"}
          }
          with open(os.path.join(OUT_DIR, "symbols.json"), "w", encoding="utf-8") as f:
            json.dump(manifest, f, ensure_ascii=False, separators=(",",":"))

          def links(sym):
            return (f"<a href='ohlcv/binance/{sym}_H4.txt'>{sym}_H4</a> | "
                    f"<a href='ohlcv/binance/{sym}_D1.txt'>{sym}_D1</a> | "
                    f"<a href='ohlcv/binance/{sym}_W1.txt'>{sym}_W1</a>")

          items = "\n".join([f"<li>{links(s)}</li>" for s in CORE10])

          html = f"""<!doctype html><meta charset="utf-8">
          <title>OHLCV Feed</title>
          <h3>OHLCV Feed (Binance Spot) â€” TXT only</h3>
          <p>Last update (UTC, by last closed H4): <code>{updated_utc}</code></p>
          <p>Manifest: <a href="ohlcv/binance/symbols.json">symbols.json</a></p>
          <ul>{items}</ul>
          """
          with open(os.path.join(SITE_DIR, "index.html"), "w", encoding="utf-8") as f:
            f.write(html)

          with open(os.path.join(SITE_DIR, ".nojekyll"), "w", encoding="utf-8") as f:
            f.write("")
          PY

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
